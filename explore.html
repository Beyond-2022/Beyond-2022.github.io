<html>

<head>
    <title>Beyond Timeline</title>
    
    <style>
        
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>
    
    <script src="https://dgraux.github.io/SPARQL-hash/sweetalert.min.js"></script>
    
    
    <script>
        
        function open_dialog(from,to) {
            
            var div = document.getElementById('chart_div');
            while(div.firstChild){
                div.removeChild(div.firstChild);
            }
            
            from = ('0' + from).slice(-4);  // Adds 0 in front of year if year is less than 999 i.e. 450 = 0450
            to = ('0' + to).slice(-4);
            console.log("From = "+from);
            console.log("To = "+to);
            
            
            var B2022_explore_query = `
            PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
            PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
            PREFIX crm: <http://erlangen-crm.org/current/>
            PREFIX b2022: <https://kb.beyond2022.ie/>
            PREFIX vt: <https://kb.virtualtreasury.ie/>
            PREFIX vt_ont: <https://ont.virtualtreasury.ie/ontology#>
            
            select distinct  ?person_name ?start_date ?end_date ?aoi_label
            
            where {
                #Get Birth and Death events and time-spans for each person
                ?birth rdf:type crm:E67_Birth;
                crm:P4_has_time-span ?timespanB;
                crm:P98_brought_into_life ?person. 
                ?death rdf:type crm:E69_Death;
                crm:P4_has_time-span ?timespanD;
                crm:P93_took_out_of_existence ?person.
                
                #Get begin-of-the-begin of Birth as start date and end-of-the-end of Death as end date
                ?timespanB crm:P82a_begin_of_the_begin ?start_date.
                ?timespanD crm:P82b_end_of_the_end ?end_date.
                FILTER (?start_date >= "`+from+`-01-01"^^xsd:date).
                FILTER (?start_date <= "`+to+`-01-01"^^xsd:date).
                
                
                #Get appellation (surname-forename) of person
                ?person crm:P1_is_identified_by ?appellation.
                ?appellation rdfs:label ?person_name.
                FILTER(CONTAINS(str(?appellation),"normalized-appellation-surname-forename")). 
                
                ?person vt_ont:DIB_area_of_interest ?aoi .
                ?aoi crm:P1_is_identified_by ?aoi_app .
                ?aoi_app rdfs:label ?aoi_label .
            } 
            ORDER BY ?start_date
            
            
            
            `   
            //  console.log(B2022_explore_query);
            
            
            
            
            var b2022_URL =  'http://localhost:3030/Beyond_2022/query';
            
            
            const queryString = window.location.search;										// returns: ?subj=...								
            const urlParams = new URLSearchParams(queryString);
            
            const subject = urlParams.get('subj');											// isolates subj eg: https://www.wikidata.org/wiki/Q937
            
            
            var queryName = "Life Timeline";
            function addMonth(date, month) 
            {
                var result = new Date(date);
                result.setMonth(result.getMonth() + month);
                return result;
            }
            
            
            d3.sparql(b2022_URL, B2022_explore_query).then(function (data) {
                
                console.log(data);
                
                data.forEach(function (arrayItem) {            // Edit deathData to have start & end date with oName
                    if (typeof arrayItem === "object") {
                        arrayItem["start"] = arrayItem.start_date;         //start is obj date
                        // arrayItem["end"] = addMonth(arrayItem.start_date, 1);     // add extra month to end date if not specified to make it visible on chart 
                        arrayItem["end"] = arrayItem.end_date;
                        arrayItem["oName"] = arrayItem.person_name;      //oName is pName
                        arrayItem["pName"] = arrayItem.aoi_label;
                    }
                });
                
                function getRandomData(ordinal = false) {
                    var groups = 1;
                    const NGROUPS = groups;
                    var MAXTIME = data[0].start;
                    var MINTIME = data[0].start;       //assume start date of first entry is earliest date
                    
                    // Need to sort array based on start-date
                    data.forEach(function (arrayItem) {             // find minimum date of query
                        if (arrayItem.start < MINTIME) {
                            MINTIME = arrayItem.start;
                        }
                        if (arrayItem.start > MAXTIME) {
                            MAXTIME = arrayItem.start;
                        }
                    });
                    
                    const sortedData = data.sort((a, b) => Date.parse(a.start) - Date.parse(b.start))
                    data = sortedData;
                    
                    return [...Array(NGROUPS).keys()].map(i => ({
                        //group: document.getElementById('textID').value,                          //left hand side of grid, need to make query name, currently set as data[0].oName
                        group: queryName,
                        data: getGroupData()
                    }));
                    
                    // the group is the subject -- Albert Einstein = g1
                    function getGroupData() {                         //called once
                        //console.log(data);
                        return [...Array(data.length).keys()].map(i => ({
                            label: data[i].oName,                     //right hand side of graph
                            data: getSegmentsData(i)
                        }));
                        
                        //
                        //ie the bars in the timeline
                        function getSegmentsData(index)                 //called data.length times
                        {
                            //console.log("getSegments called");
                            //const nSegments = data.length,
                            const nSegments = 1,                                                         
                            segMaxLength = Math.round(((new Date()) - MINTIME) / nSegments);        
                            // console.log(segMaxLength);
                            let runLength = MINTIME;                                                        // earliest date in timeline?
                            return [...Array(nSegments).keys()].map(i => {
                                start = data[index].start,                              //every entry has a start date
                                end = data[index].end ? data[index].end : new Date();   //set end date to end date if present otherwise set to current date
                                
                                runLength = new Date(start.getTime() + segMaxLength);         
                                
                                return {
                                    timeRange: [start, end],        // shows start date to end date on hover
                                    val: data[index].pName,         // shows pName on hover
                                    //val: "Interests: "+ data[index].pName,         // shows pName on hover
                                    // val: "Lifetime",         // shows pName on hover
                                    duartion: data[index].start + " - " + data[index].end
                                    //labelVal: is optional - only displayed in the labels
                                };
                            });
                        }
                    }
                }                             //red      orange      yellow      green     brown      purple      pink      blue
                // let scale = d3.scaleOrdinal(['#E67B7B', '#FF8F00', '#FFF300', '#6AD96A', '#9D6F6F', '#726AD9', '#C16AD9', '#6A8AD9']);    // red, orange, yellow, green, blue, lilac, purple
                let scale = d3.scaleOrdinal(['#dff32a', '#78850a', '#70050a', '#0a8575', '#3867e7', '#f55e83', '#e4990f', '#e46f0f']);
                
                function segmentClick(segment) {
                    console.log(segment.target.__data__.label);
                    var segmentName = segment.target.__data__.label;
                    var queryCode;
                    for (i = 0; i < data.length; i++) {
                        if (data[i].oName == segmentName) {
                            queryCode = data[i].obj;
                            break;
                        }
                    }
                    console.log(queryCode);
                    window.open('explore.html?subj=http://localhost:3030/Beyond_2022/query', '_self');
                    
                }
                
                
                
                TimelinesChart()
                .rightMargin(200)               // 200 pixels
                .leftMargin(100)
                .maxHeight(1920)
                .maxLineHeight(17)
                .topMargin(40)
                .data(getRandomData(true))
                .onSegmentClick(segmentClick)
                //.sortChrono([true])             //Places in order of end date if true
                .zQualitative(true)             //https://github.com/vasturiano/timelines-chart for more details
                .zColorScale(scale)             // Uses scale above to color each oName
                .zScaleLabel('Consumo')
                (document.getElementById('chart_div'));
                
                
            }); //end of B2022_Death_Query    
            
            
            
            
        }
    </script>
    
</head>

<body>
    
    <div class="range-slider">
        Year interval to be considered:<br>The interval can be either dragged keeping the same time span, or adjusted using the handles.<br>
        <input type="text" class="js-range-slider" value="" />
    </div>
    <div class="extra-controls">
        <input type="text" class="js-input-from" value="0" />
        <input type="text" class="js-input-to" value="0" />
        (These are just to show that the input boxes and the slider are "connected".)<br>
        By default the maximum year interval is supposed to be 600 years, but it can be overwritten using the input boxes above... (however, it will throw an alert message when clicking on the search button)<br>
        <button onclick="
        
        open_dialog($('.js-input-from').prop('value'),$('.js-input-to').prop('value'))">Search...</button>
    </div>
    
    <div id="chart_div" style="overflow-x: scroll; overflow-y: scroll; height: 100%; width: 100%;font-size: 11px; ">
    </div>
    
    <!--jQuery-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!--Plugin JavaScript file-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
    
    <script>
        var $range = $(".js-range-slider"),
        $inputFrom = $(".js-input-from"),
        $inputTo = $(".js-input-to"),
        instance,
        min = 5,
        max = 1687,
        from = 0,
        to = 0;
        
        $range.ionRangeSlider({
            skin: "flat",
            type: "double",
            grid: true,
            min: min,
            max: max,
            from: 210,
            to: 413,
            drag_interval: true,
            min_interval: null,
            max_interval: 600,
            onStart: updateInputs,
            onChange: updateInputs
        });
        instance = $range.data("ionRangeSlider");
        
        function updateInputs (data) {
            from = data.from;
            to = data.to;
            
            $inputFrom.prop("value", from);
            $inputTo.prop("value", to);	
        }
        
        $inputFrom.on("input", function () {
            var val = $(this).prop("value");
            
            // validate
            if (val < min) {
                val = min;
            } else if (val > to) {
                val = to;
            }
            
            instance.update({
                from: val
            });
        });
        
        $inputTo.on("input", function () {
            var val = $(this).prop("value");
            
            // validate
            if (val < from) {
                val = from;
            } else if (val > max) {
                val = max;
            }
            
            instance.update({
                to: val
            });
        });
    </script>
    
    
    <script src="assets/js/Nav.js"></script>
    <script src="assets/js/Search.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
    crossorigin="anonymous"></script>
    
    <script type="text/javascript" src="assets/js/jquery-3.2.1.min.js"></script>
    
    
    <script type="text/javascript" src="assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/js/lightgallery.min.js"></script>
    <script type="text/javascript" src="assets/js/parallax.min.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
    
    
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    
    <script src="https://unpkg.com/timelines-chart@v2.11.1/dist/timelines-chart.min.js"></script>
    
    
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="style.css">
    <link rel="wikidata icon" href="pic/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link
    href="https://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">
    <link rel="stylesheet" href="css/stylesheet.css">
    <!-- <link rel="stylesheet" href="css/searchButton.css"> -->
</body>

</html>
