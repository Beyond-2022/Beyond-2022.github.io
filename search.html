<html>

<head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
<!--     <script src="https://unpkg.com/timelines-chart"></script> -->
    <script src="https://unpkg.com/timelines-chart@v2.11.1/dist/timelines-chart.min.js"></script>

    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, inital-scale=1.0"> -->
    <title>Beyond 2022</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="style.css">
    <link rel="wikidata icon" href="pic/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">

    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link
        href="https://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">
    <link rel="stylesheet" href="css/stylesheet.css">




    <script type="text/javascript">

        var b2022_URL =  'https://localhost:3030/Beyond_2022/query';
        // var b2022_URL =  'http://localhost:9999/blazegraph/namespace/b2022/sparql';

        const queryString = window.location.search;										// returns: ?subj=...								
        const urlParams = new URLSearchParams(queryString);
        
        const subject = urlParams.get('subj');											// isolates subj eg: https://www.wikidata.org/wiki/Q937

        //var B2022_localhost_link = 'http://localhost:3030/Beyond2022_DB/query';
        
  //       var B2022_query = `
  //       PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
        // PREFIX crm_cur: <http://erlangen-crm.org/current/>
        // PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
        // PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
        // PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

        // SELECT ?subject ?predicate ?object
  //       #Comment
        // WHERE {
  // 			?subject ?predicate crm_cur:E52_Time-Span 
        // }
        // LIMIT 100

  //       `;


          var  B2022_death_query = `
                #Query to only get death dates of people
                PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
                PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                PREFIX crm: <http://erlangen-crm.org/current/>
                PREFIX b2022: <https://kb.beyond2022.ie/>
                PREFIX vt: <https://kb.virtualtreasury.ie/>

                select distinct ?person_name ?start_date ?end_date ?event
                where {
                  #Only get Death Event
                  ?event rdf:type crm:E69_Death ; 
                         crm:P4_has_time-span ?timespan;
                         crm:P93_took_out_of_existence ?person.

                  #Get begin of the begin of birth date and end of end of death event
                  ?timespan crm:P82a_begin_of_the_begin ?start_date;
                            crm:P82b_end_of_the_end ?end_date.
                  
                  ?person crm:P1_is_identified_by ?appellation.
                  ?appellation rdfs:label ?person_name.
                  FILTER(CONTAINS(str(?appellation),"normalized-appellation-surname-forename")). 
                } 
                ORDER BY ?start_date
                LIMIT 50
                `;


          var B2022_query = `
                   PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
                    PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
                    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                    PREFIX crm: <http://erlangen-crm.org/current/>
                    PREFIX b2022: <https://kb.beyond2022.ie/>

                    select distinct *
                    where {
                      VALUES (?event_type) { ( crm:E67_Birth ) ( crm:E69_Death ) } 
                      ?event rdf:type ?event_type ; 
                             crm:P4_has_time-span ?timespan;
                             ?death_Birth ?person.
                        VALUES (?death_Birth) { ( crm:P98_brought_into_life ) ( crm:P93_took_out_of_existence ) } 
                      ?timespan crm:P82a_begin_of_the_begin ?start_date ; 
                                crm:P82b_end_of_the_end ?end_date.
                      ?person crm:P1_is_identified_by ?appellation.
                      ?appellation rdfs:label ?person_name.
                      FILTER(CONTAINS(str(?appellation),"normalized-appellation-surname-forename")). 
                    } 
                    ORDER BY ?start_date
                    LIMIT 100

                `;

        var queryName = "Death Dates";
        function addMonth(date, month) 
        {
            var result = new Date(date);
            result.setMonth(result.getMonth() + month);
            return result;
        }

 
    d3.sparql(b2022_URL, B2022_death_query).then(function (data) {
                
                 console.log(data);
                
                data.forEach(function (arrayItem) {            // Edit deathData to have start & end date with oName
                if (typeof arrayItem === "object") {
                    arrayItem["start"] = arrayItem.start_date;         //start is obj date
                    arrayItem["end"] = addMonth(arrayItem.start_date, 1);     // add extra month to end date if not specified to make it visible on chart 
                    arrayItem["oName"] = arrayItem.person_name;      //oName is pName
                }
            });

            function getRandomData(ordinal = false) {
                    var groups = 1;
                    const NGROUPS = groups;
                    var MAXTIME = data[0].start;
                    var MINTIME = data[0].start;       //assume start date of first entry is earliest date

                    // Need to sort array based on start-date
                    data.forEach(function (arrayItem) {             // find minimum date of query
                        if (arrayItem.start < MINTIME) {
                            MINTIME = arrayItem.start;
                        }
                        if (arrayItem.start > MAXTIME) {
                            MAXTIME = arrayItem.start;
                        }
                    });

                    const sortedData = data.sort((a, b) => Date.parse(a.start) - Date.parse(b.start))
                    data = sortedData;

                    return [...Array(NGROUPS).keys()].map(i => ({
                        //group: document.getElementById('textID').value,                          //left hand side of grid, need to make query name, currently set as data[0].oName
                        group: queryName,
                        data: getGroupData()
                    }));

                    // the group is the subject -- Albert Einstein = g1
                    function getGroupData() {                         //called once
                        //console.log(data);
                        return [...Array(data.length).keys()].map(i => ({
                            label: data[i].oName,                     //right hand side of graph
                            data: getSegmentsData(i)
                        }));

                        //
                        //ie the bars in the timeline
                        function getSegmentsData(index)                 //called data.length times
                        {
                            //console.log("getSegments called");
                            //const nSegments = data.length,
                            const nSegments = 1,                                                         
                                segMaxLength = Math.round(((new Date()) - MINTIME) / nSegments);        
                            // console.log(segMaxLength);
                            let runLength = MINTIME;                                                        // earliest date in timeline?
                            return [...Array(nSegments).keys()].map(i => {
                                start = data[index].start,                              //every entry has a start date
                                    end = data[index].end ? data[index].end : new Date();   //set end date to end date if present otherwise set to current date

                                runLength = new Date(start.getTime() + segMaxLength);         

                                return {
                                    timeRange: [start, end],        // shows start date to end date on hover
                                    val: data[index].pName,         // shows pName on hover
                                    duartion: data[index].start + " - " + data[index].end
                                    //labelVal: is optional - only displayed in the labels
                                };
                            });
                        }
                    }
                }                             //red      orange      yellow      green     brown      purple      pink      blue
                let scale = d3.scaleOrdinal(['#E67B7B', '#FF8F00', '#FFF300', '#6AD96A', '#9D6F6F', '#726AD9', '#C16AD9', '#6A8AD9']);    // red, orange, yellow, green, blue, lilac, purple

                function segmentClick(segment) {
                    console.log(segment.target.__data__.label);
                    var segmentName = segment.target.__data__.label;
                    var queryCode;
                    for (i = 0; i < data.length; i++) {
                        if (data[i].oName == segmentName) {
                            queryCode = data[i].obj;
                            break;
                        }
                    }
                    console.log(queryCode);
                    window.open('https://Beyond-2022.github.io/search.html?subj=https://localhost:3030/Beyond_2022/query', '_self');
                    // window.open('file:///Users/tanmay/Documents/GitHub/Beyond-2022.github.io/search.html?subj=http://localhost:3030/Beyond_2022/query', '_self');
                }



                TimelinesChart()
                    .rightMargin(200)               // 200 pixels
                    .leftMargin(100)
                    .maxHeight(1920)
                    .maxLineHeight(17)
                    .topMargin(40)
                    .data(getRandomData(true))
                    .onSegmentClick(segmentClick)
                    //.sortChrono([true])             //Places in order of end date if true
                    .zQualitative(true)             //https://github.com/vasturiano/timelines-chart for more details
                    .zColorScale(scale)             // Uses scale above to color each oName
                    .zScaleLabel('Consumo')
                    (document.getElementById('chart_div'));
                
        
    }); //end of B2022_Death_Query    

    

</script>


</head>

<body>
    <header class="site-header site2-header site3-header header-default header-sticky animated">
        <div class="container-fluid">
            <div class="site2-header1">
                <div class="row">
                    <div class="col-md-2 fix-logo">
                        <div class="wrapper-logo">
                            <a href="index.html" class="logo-default"><img src="pic/logo.png" height="64"
                                    alt="AYF" /></a>
                        </div>
                    </div>
                    <div class="col-md-4 col-md-push-6 fix-social">

                        <a href="https://github.com/Beyond-2022/Beyond-2022.github.io.git" class="buy-ticket"><img
                                src="pic/GitHub-Logo.png" alt="AYF" /></a>
                    </div>
                    <div class="col-md-6 col-md-pull-4 fix-menu">
                        <div class="row">
                            <nav class="main-menu">
                                <ul class="nav-bar">
                                     <li><a href="index.html">home</a>
                </li>
                <li><a href="about.html">About</a>
                </li>
                <li><a href="contributor.html">Contributors</a>
                </li>
                <li><a href="something_fun.html">Something Fun</a>
                </li>
                <li><a href="compare.html">Compare</a>
                </li>
                                </ul>
                            </nav>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="page-heading">
        <h1 class="entry-title"></h1>
        <h3 style="color: white;">How to Search?</h3>
        <h5 style="color: white;">Enter a Resource name & choose one of the given options. Click on “Submit” to draw the
            timeline.</h5>
        <h5 style="color: white;">Click on the timeline bars to jump to a new timeline. </h5>
        <h5 style="color: white;">Select the area with your cursor to zoom-in on the timeline.</h5>
        <ul class="entry-breadcrumb">
        </ul>
    </div>
    <br> </br>
    <div id="Search" class="searchbar">
        <input type="text" class="searchbox" placeholder="Enter a query..." id="text"
            style="width: 60%; height: 35px " />
        <input type='hidden' id='textID' />
       

        
        
        <!-- <input type="button" class="searchbar-button" id="btn" value="Submit"
            onClick="javascript: window.open('file:///Users/tanmay/Documents/GitHub/Beyond-2022.github.io/search.html?subj=http://localhost:3030/Beyond_2022/query', '_self');" />
         -->
        <input type="button" class="searchbar-button" id="btn" value="Submit"
            onClick="javascript: window.open('https://beyond-2022.github.io/search.html?subj=https://localhost:3030/Beyond_2022/query', '_self');" />
    </div>
    <br> </br>
    <div id="chart_div" style="overflow-x: scroll; overflow-y: scroll; height: 100%; width: 100%;font-size: 11px; ">
    </div>


    <!-- Search wikiData SPARQL database and retrieve corrsepond Qxyz-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet"
        href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>

    <script type="text/javascript">
        $(".searchbox").autocomplete({
            source: function (request, response) {
                console.log(request.term);
                $.ajax({
                    url: "https://www.wikidata.org/w/api.php",
                    dataType: "jsonp",
                    data: {
                        'action': "wbsearchentities",
                        'format': "json",
                        'language': "en",
                        'search': request.term
                    },
                    success: function (data) {
                        //response(data.search);
                        response($.map(data.search, function (item) {
                            return {
                                label: item.label + " (" + item.description + ")",
                                value: item.label,
                                id: item.id,
                                description: item.description
                            }
                        }));
                    }
                });
            },
            minLength: 3,
            select: function (event, ui) {
                console.log("Selected: " + ui.item.label + ", having the Wikidata entity: " + ui.item.id);
                $("#text").val(ui.item.value);
                $("#textID").val(ui.item.id); return false;
            }
        });
    </script>

    <script src="assets/js/Nav.js"></script>
    <script src="assets/js/Search.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sparql@2.0.0/build/d3-sparql.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>

    <script type="text/javascript" src="assets/js/jquery-3.2.1.min.js"></script>

    
    <script type="text/javascript" src="assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="assets/js/lightgallery.min.js"></script>
    <script type="text/javascript" src="assets/js/parallax.min.js"></script>
    <script type="text/javascript" src="assets/js/main.js"></script>
</body>

</html>
